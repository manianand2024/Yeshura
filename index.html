<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeshura | Real-time SOC 2 Auditor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; transition: all 0.3s; }
        .row-active { background-color: #f0f9ff !important; border-left: 4px solid #0ea5e9; }
        .btn-save { background-color: #0ea5e9; color: white; padding: 6px 12px; rounded: 6px; font-weight: 600; font-size: 12px; }
        .btn-save:hover { background-color: #0284c7; }
        th { text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #64748b; padding: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const initialSOC2Data = [
            { id: '1', domain: 'Security', trustServiceCriteria: 'CC1.1', controlDescription: 'The entity demonstrates a commitment to integrity and ethical values.', currentStatus: 'No', evidenceAvailable: false, gapIdentified: true, fileName: '' },
            { id: '2', domain: 'Security', trustServiceCriteria: 'CC1.2', controlDescription: 'The board demonstrates independence and exercises oversight.', currentStatus: 'No', evidenceAvailable: false, gapIdentified: true, fileName: '' },
            { id: '3', domain: 'Security', trustServiceCriteria: 'CC1.3', controlDescription: 'Management establishes reporting lines and authorities.', currentStatus: 'No', evidenceAvailable: false, gapIdentified: true, fileName: '' },
            { id: '4', domain: 'Availability', trustServiceCriteria: 'A1.1', controlDescription: 'The entity maintains and monitors system availability.', currentStatus: 'No', evidenceAvailable: false, gapIdentified: true, fileName: '' }
        ];

        // SUB-COMPONENT: Single Row for Inline Editing
        const ControlRow = ({ control, onSave }) => {
            const [localData, setLocalData] = useState({...control});
            const [isDirty, setIsDirty] = useState(false);

            const handleChange = (field, value) => {
                setLocalData(prev => ({ ...prev, [field]: value }));
                setIsDirty(true);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    setLocalData(prev => ({ ...prev, fileName: file.name, evidenceAvailable: true }));
                    setIsDirty(true);
                }
            };

            const triggerSave = () => {
                onSave(localData);
                setIsDirty(false);
            };

            return (
                <tr className={`border-b border-slate-100 transition-colors ${isDirty ? 'row-active' : 'hover:bg-slate-50'}`}>
                    <td className="p-4 font-bold text-sky-600 font-mono text-sm">{localData.trustServiceCriteria}</td>
                    <td className="p-4 text-sm text-slate-600 max-w-xs">{localData.controlDescription}</td>
                    <td className="p-4">
                        <select 
                            value={localData.currentStatus}
                            onChange={(e) => handleChange('currentStatus', e.target.value)}
                            className="text-sm border border-slate-300 rounded p-1 focus:ring-2 focus:ring-sky-500 outline-none"
                        >
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </td>
                    <td className="p-4">
                        <div className="flex flex-col gap-1">
                            <input 
                                type="file" 
                                id={`file-${localData.id}`} 
                                className="hidden" 
                                onChange={handleFileChange}
                            />
                            <label 
                                htmlFor={`file-${localData.id}`} 
                                className="text-[10px] cursor-pointer bg-slate-100 border border-slate-300 px-2 py-1 rounded text-center hover:bg-slate-200"
                            >
                                {localData.fileName ? 'ðŸ“Ž ' + localData.fileName : 'Attach Evidence'}
                            </label>
                        </div>
                    </td>
                    <td className="p-4 text-center">
                        <span className={`px-2 py-1 rounded-full text-[10px] font-bold ${localData.gapIdentified ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                            {localData.gapIdentified ? 'GAP' : 'PASS'}
                        </span>
                    </td>
                    <td className="p-4">
                        <button 
                            onClick={triggerSave}
                            disabled={!isDirty}
                            className={`w-full px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${isDirty ? 'bg-sky-500 text-white' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}`}
                        >
                            Save Row
                        </button>
                    </td>
                </tr>
            );
        };

        function App() {
            const [controls, setControls] = useState(initialSOC2Data);

            const handleRowUpdate = (updatedRow) => {
                // Gap identification logic from ControlsController.cs
                const hasGap = updatedRow.currentStatus === 'No' || !updatedRow.evidenceAvailable;
                
                setControls(prev => prev.map(c => 
                    c.id === updatedRow.id ? { ...updatedRow, gapIdentified: hasGap } : c
                ));
            };

            const total = controls.length;
            const gaps = controls.filter(c => c.gapIdentified).length;
            const readiness = Math.round(((total - gaps) / total) * 100);

            return (
                <div className="max-w-6xl mx-auto py-12 px-6">
                    <header className="mb-10 flex justify-between items-end">
                        <div>
                            <h1 className="text-3xl font-black text-slate-900 tracking-tight">YESHURA <span className="text-sky-500 italic">Audit Lab</span></h1>
                            <p className="text-slate-500 mt-1">Real-time SOC 2 Control Verification</p>
                        </div>
                        <div className="text-right">
                            <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Instance Status</span>
                            <div className="flex items-center gap-2 justify-end">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="text-sm font-semibold">Active Session</span>
                            </div>
                        </div>
                    </header>

                    {/* Dashboard Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div className="stat-card">
                            <p className="text-sm font-bold text-slate-400 uppercase">Readiness Score</p>
                            <h2 className="text-4xl font-black mt-1">{readiness}%</h2>
                            <div className="w-full bg-slate-100 h-2 mt-4 rounded-full overflow-hidden">
                                <div className="bg-sky-500 h-full transition-all duration-500" style={{width: `${readiness}%`}}></div>
                            </div>
                        </div>
                        <div className="stat-card">
                            <p className="text-sm font-bold text-slate-400 uppercase">Critical Gaps</p>
                            <h2 className={`text-4xl font-black mt-1 ${gaps > 0 ? 'text-red-500' : 'text-green-500'}`}>{gaps}</h2>
                            <p className="text-xs text-slate-400 mt-4 italic">Action required for compliance</p>
                        </div>
                        <div className="stat-card">
                            <p className="text-sm font-bold text-slate-400 uppercase">Controls Verified</p>
                            <h2 className="text-4xl font-black mt-1 text-sky-600">{total - gaps} / {total}</h2>
                            <p className="text-xs text-slate-400 mt-4 italic">Evidence-backed controls</p>
                        </div>
                    </div>

                    {/* Audit Table */}
                    <div className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th>Criteria</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Evidence</th>
                                    <th className="text-center">Gap</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {controls.map(c => (
                                    <ControlRow key={c.id} control={c} onSave={handleRowUpdate} />
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <footer className="mt-8 text-center text-slate-400 text-xs">
                        &copy; 2024 Yeshura GRC Lab â€¢ Theory to Practice Framework
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
